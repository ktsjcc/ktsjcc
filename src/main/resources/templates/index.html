<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Stocks Drop Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { background: #0b1420; color: #cdd6f4; }
    .card { background: #111b2a; border: 1px solid #1e2a3a; }
    .badge-buy { background: linear-gradient(90deg, #14b8a6, #22d3ee); }
    .badge-watch { background: linear-gradient(90deg, #f59e0b, #f97316); }
    .table thead th { color: #93c5fd; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">US Stocks Real-time Drop Monitor</h2>
    <div>
      <span th:if="${greedIndex != null}" class="badge rounded-pill" th:text="${'Fear & Greed: ' + greedIndex.label + ' (' + greedIndex.value + ')'}" style="background: linear-gradient(90deg,#64748b,#94a3b8);"></span>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <h6 class="mb-2">Sector Hotspots (volume-weighted)</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Sector</th><th>Losers</th><th>Total Vol</th><th>Avg Drop%</th></tr></thead>
            <tbody>
            <tr th:each="h : ${hotspots}">
              <td th:text="${h.sector}"></td>
              <td th:text="${h.losersCount}"></td>
              <td th:text="${h.totalVolume}"></td>
              <td th:text="${#numbers.formatDecimal(h.averageDropPercent,1,2)}"></td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 h-100">
        <h6 class="mb-2">Top Picks (Value-weighted)</h6>
        <ol class="mb-0" th:if="${topPicks != null}">
          <li th:each="p : ${topPicks}" th:text="${p.symbol + ' — ' + p.reason}"></li>
        </ol>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-auto">
        <label for="symbol" class="form-label">Symbol</label>
        <input id="symbol" class="form-control form-control-sm" placeholder="AAPL"/>
      </div>
      <div class="col-auto">
        <label for="capital" class="form-label">Capital (USD)</label>
        <input id="capital" type="number" class="form-control form-control-sm" placeholder="10000"/>
      </div>
      <div class="col-auto">
        <button id="planBtn" class="btn btn-sm btn-primary">Compute Trade Plan</button>
      </div>
      <div class="col" id="planResult"></div>
    </div>
  </div>

  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
        <tr>
          <th>Symbol</th>
          <th>Name</th>
          <th>Sector</th>
          <th>Drop%</th>
          <th>Price</th>
          <th>RSI</th>
          <th>Vol Z</th>
          <th>Quality</th>
          <th>Valuation</th>
          <th>Momentum</th>
          <th>Signal</th>
        </tr>
        </thead>
        <tbody id="tbody">
        <tr th:each="a : ${analyses}">
          <td th:text="${a.symbol}"></td>
          <td th:text="${a.name}"></td>
          <td th:text="${a.sector}"></td>
          <td th:text="${#numbers.formatDecimal(a.quote.changePercent,1,2)}"></td>
          <td th:text="${#numbers.formatDecimal(a.quote.price,1,2)}"></td>
          <td th:text="${#numbers.formatDecimal(a.technicals.rsi14,1,1)}"></td>
          <td th:text="${#numbers.formatDecimal(a.technicals.volumeZScore,1,2)}"></td>
          <td th:text="${#numbers.formatDecimal(a.qualityScore*100,1,0) + '%'}"></td>
          <td th:text="${#numbers.formatDecimal(a.valuationScore*100,1,0) + '%'}"></td>
          <td th:text="${#numbers.formatDecimal(a.momentumScore*100,1,0) + '%'}"></td>
          <td>
            <span th:if="${a.signal == 'BUY'}" class="badge badge-buy">BUY</span>
            <span th:if="${a.signal == 'WATCH'}" class="badge badge-watch">WATCH</span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-auto">
        <label for="mcSymbol" class="form-label">Symbol</label>
        <input id="mcSymbol" class="form-control form-control-sm" placeholder="AAPL"/>
      </div>
      <div class="col-auto">
        <label for="horizon" class="form-label">Horizon (days)</label>
        <input id="horizon" type="number" class="form-control form-control-sm" value="20"/>
      </div>
      <div class="col-auto">
        <label for="vol" class="form-label">Daily Vol (σ)</label>
        <input id="vol" type="number" step="0.001" class="form-control form-control-sm" value="0.03"/>
      </div>
      <div class="col-auto">
        <button id="mcBtn" class="btn btn-sm btn-secondary">Run Monte Carlo</button>
      </div>
      <div class="col" id="mcResult"></div>
    </div>
  </div>
</div>
<script>
  document.getElementById('planBtn').addEventListener('click', async () => {
    const symbol = document.getElementById('symbol').value.trim();
    const capital = document.getElementById('capital').value.trim();
    if (!symbol || !capital) return;
    const params = new URLSearchParams({symbol, capital});
    const resp = await fetch('/api/trade-plan', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: params});
    const data = await resp.json();
    const pr = document.getElementById('planResult');
    pr.innerHTML = `Entry: $${data.suggestedEntry.toFixed(2)} | SL: $${data.stopLoss.toFixed(2)} | TP: $${data.takeProfit.toFixed(2)} | Qty: ${data.quantity} (${data.method})`;
  });
  document.getElementById('mcBtn').addEventListener('click', async () => {
    const symbol = document.getElementById('mcSymbol').value.trim();
    const horizon = document.getElementById('horizon').value.trim();
    const vol = document.getElementById('vol').value.trim();
    if (!symbol) return;
    const params = new URLSearchParams({symbol, horizonDays: horizon, dailyVolatility: vol});
    const resp = await fetch('/api/monte-carlo', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: params});
    const data = await resp.json();
    document.getElementById('mcResult').innerHTML = `P(Profit): ${(data.prob*100).toFixed(1)}% | E[ret]: ${(data.exp*100).toFixed(2)}% | VaR95: ${(data.var95*100).toFixed(2)}%`;
  });
  // Auto-refresh table every 2 minutes
  setInterval(async () => {
    const resp = await fetch('/api/analyses');
    const list = await resp.json();
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    list.forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.symbol}</td>
        <td>${a.name || ''}</td>
        <td>${a.sector || ''}</td>
        <td>${(a.quote?.changePercent||0).toFixed(2)}</td>
        <td>${(a.quote?.price||0).toFixed(2)}</td>
        <td>${(a.technicals?.rsi14||0).toFixed(1)}</td>
        <td>${(a.technicals?.volumeZScore||0).toFixed(2)}</td>
        <td>${((a.qualityScore||0)*100).toFixed(0)}%</td>
        <td>${((a.valuationScore||0)*100).toFixed(0)}%</td>
        <td>${((a.momentumScore||0)*100).toFixed(0)}%</td>
        <td><span class="badge ${a.signal==='BUY'?'badge-buy':'badge-watch'}">${a.signal}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }, 120000);
</script>
</body>
</html>